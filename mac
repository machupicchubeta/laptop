#!/bin/bash
set -eu
cd "$HOME"

echo "Generate key pair"
if [ ! -e "$HOME/.ssh/id_rsa" ]; then
  read -p "email: " email
  ssh-keygen -t rsa -b 4096 -C $email
  eval "$(ssh-agent -s)"
  ssh-add -K "$HOME/.ssh/id_rsa"
fi

echo "Install Homebrew"
if [ ! -x "$(command -v brew)" ]; then
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

echo "Install commands and Apps"
bash <(curl -fsSL https://raw.githubusercontent.com/machupicchubeta/dotfiles/master/bin/brewfile.sh)

echo "Install oh-my-zsh"
if [ ! -d "$HOME/.oh-my-zsh" ]; then
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)" "" --unattended
fi

echo "Create directories"
if [ ! -d "$HOME/tmp" ]; then
  mkdir "$HOME/tmp"
fi
if [ ! -d "$HOME/Applications" ]; then
  mkdir "$HOME/Applications"
fi
if [ ! -d "$HOME/Develop" ]; then
  mkdir "$HOME/Develop"
fi

echo "Change screencapture store directory"
SCREENSHOTS_PATH="$HOME/Screenshots"
if [ ! -d "$SCREENSHOTS_PATH" ]; then
  mkdir "$SCREENSHOTS_PATH"
fi
defaults write com.apple.screencapture location "$SCREENSHOTS_PATH"
killall SystemUIServer

echo "Copy SFMono fonts to User font directory"
cp -f /System/Applications/Utilities/Terminal.app/Contents/Resources/Fonts/*.otf $HOME/Library/Fonts/

echo "Download settings and themes"
SETUP_PATH="$HOME/setup"
if [ ! -e $SETUP_PATH/laptop/mac ]; then
  mkdir -p $SETUP_PATH && cd $SETUP_PATH && git clone git@github.com:machupicchubeta/laptop.git
else
  cd $SETUP_PATH/laptop && git checkout master && git pull --rebase --prune
fi
TOOLS_PATH="$HOME/Tools"
if [ ! -d "$TOOLS_PATH" ]; then
  mkdir "$TOOLS_PATH"
fi
SETTINGS_PATH="$TOOLS_PATH/dotfiles"
if [ ! -d "$SETTINGS_PATH" ]; then
  git clone git@github.com:machupicchubeta/dotfiles.git "$SETTINGS_PATH"
else
  cd "$SETTINGS_PATH" && git checkout master && git pull --rebase --prune
fi
if [ ! -d "$TOOLS_PATH/diceware" ]; then
  git clone git@github.com:machupicchubeta/diceware.git "$TOOLS_PATH/diceware"
else
  cd "$TOOLS_PATH/diceware" && git checkout master && git pull --rebase --prune
fi
if [ ! -d "$TOOLS_PATH/altercation/solarized" ]; then
  git clone git@github.com:altercation/solarized.git "$TOOLS_PATH/altercation/solarized"
else
  cd "$TOOLS_PATH/altercation/solarized" && git checkout master && git pull --rebase --prune
fi
if [ ! -d "$TOOLS_PATH/mbadolato/iTerm2-Color-Schemes" ]; then
  git clone git@github.com:mbadolato/iTerm2-Color-Schemes.git "$TOOLS_PATH/mbadolato/iTerm2-Color-Schemes"
else
  cd "$TOOLS_PATH/mbadolato/iTerm2-Color-Schemes" && git checkout master && git pull --rebase --prune
fi
if [ ! -d "$TOOLS_PATH/seebi/dircolors-solarized" ]; then
  git clone git@github.com:seebi/dircolors-solarized.git "$TOOLS_PATH/seebi/dircolors-solarized"
else
  cd "$TOOLS_PATH/seebi/dircolors-solarized" && git checkout master && git pull --rebase --prune
fi
if [ ! -d "$TOOLS_PATH/erikw/tmux-powerline" ]; then
  git clone git@github.com:erikw/tmux-powerline.git "$TOOLS_PATH/erikw/tmux-powerline"
else
  cd "$TOOLS_PATH/erikw/tmux-powerline" && git checkout master && git pull --rebase --prune
fi
if [ ! -d "$TOOLS_PATH/mollifier/4979906" ]; then
  git clone git@gist.github.com:4979906.git "$TOOLS_PATH/mollifier/4979906"
else
  cd "$TOOLS_PATH/mollifier/4979906" && git checkout master && git pull --rebase --prune
fi
if [ ! -d "$TOOLS_PATH/tony/tmux-config" ]; then
  git clone git@github.com:tony/tmux-config.git "$TOOLS_PATH/tony/tmux-config"
else
  cd "$TOOLS_PATH/tony/tmux-config" && git checkout master && git pull --rebase --prune
fi

echo "Put settings"
for dot_directory in $(find $SETTINGS_PATH/.* -type d -d 0 ! -path "$SETTINGS_PATH/." ! -path "$SETTINGS_PATH/.." ! -path "$SETTINGS_PATH/.git"); do
  dot_directory_name=$(basename "$dot_directory")
  if [ -L "$HOME/$dot_directory_name" ]; then
    unlink "$HOME/$dot_directory_name"
  fi
  if [ -e "$HOME/$dot_directory_name" ]; then
    mv "$HOME/$dot_directory_name" "$HOME/$dot_directory_name"_"$(date +%Y-%m-%dT%H:%M:%S%z)"
  fi
  ln -s "$dot_directory" "$HOME/$dot_directory_name"
done
: ${XDG_CONFIG_HOME:=$HOME/.config}
if [ ! -d "$XDG_CONFIG_HOME" ]; then
  mkdir "$XDG_CONFIG_HOME"
fi
if [ -L "$XDG_CONFIG_HOME/nvim" ]; then
  unlink "$XDG_CONFIG_HOME/nvim"
fi
ln -s "$SETTINGS_PATH/.vim" "$XDG_CONFIG_HOME/nvim"
for dot_file in $(find "$HOME"/Tools/dotfiles/.* -type f -d 0); do
  dot_filename=$(basename "$dot_file")
  if [ -L "$HOME/$dot_filename" ]; then
    unlink "$HOME/$dot_filename"
  fi
  if [ -e "$HOME/$dot_filename" ]; then
    mv "$HOME/$dot_filename" "$HOME/$dot_filename"_"$(date +%Y-%m-%dT%H:%M:%S%z)"
  fi
  ln -s "$dot_file" "$HOME/$dot_filename"
done
if [ -L /etc/my.cnf ]; then
  sudo unlink /etc/my.cnf
fi
if [ -e /etc/my.cnf ]; then
  sudo mv /etc/my.cnf /etc/my.cnf_"$(date +%Y-%m-%dT%H:%M:%S%z)"
fi
sudo ln -s "$SETTINGS_PATH/mysql/my-utf8mb4.cnf" /etc/my.cnf
if [ -L "$HOME/.zshrc.pre-oh-my-zsh" ]; then
  unlink "$HOME/.zshrc.pre-oh-my-zsh"
fi
RBENV_PATH="$HOME/.rbenv"
if [ ! -d "$RBENV_PATH" ]; then
  mkdir "$RBENV_PATH"
fi
if [ -L "$RBENV_PATH/default-gems" ]; then
  unlink "$RBENV_PATH/default-gems"
fi
ln -s "$SETTINGS_PATH/rbenv/default-gems" "$RBENV_PATH/default-gems"

echo "Put script files"
BIN_PATH="$HOME/bin"
if [ ! -d "$BIN_PATH" ]; then
  mkdir "$BIN_PATH"
fi
for bin_file in "$HOME"/Tools/dotfiles/bin/*; do
  bin_filename=$(basename "$bin_file")
  if [ -L "$BIN_PATH/$bin_filename" ]; then
    unlink "$BIN_PATH/$bin_filename"
  fi
  if [ -e "$BIN_PATH/$bin_filename" ]; then
    mv "$BIN_PATH/$bin_filename" "$BIN_PATH/$bin_filename"_"$(date +%Y-%m-%dT%H:%M:%S%z)"
  fi
  ln -s "$bin_file" "$BIN_PATH/$bin_filename"
done
if [ -L "$BIN_PATH/diceware.rb" ]; then
  unlink "$BIN_PATH/diceware.rb"
fi
ln -s "$TOOLS_PATH/diceware/diceware.rb" "$BIN_PATH/diceware.rb"
if [ -L "$BIN_PATH/diceware.wordlist.asc" ]; then
  unlink "$BIN_PATH/diceware.wordlist.asc"
fi
ln -s "$TOOLS_PATH/diceware/diceware.wordlist.asc" "$BIN_PATH/diceware.wordlist.asc"

echo "Setup Ruby"
bash <(curl -fsSL https://raw.githubusercontent.com/machupicchubeta/dotfiles/master/bin/setup_ruby.sh)

echo "Setup Python"
bash <(curl -fsSL https://raw.githubusercontent.com/machupicchubeta/dotfiles/master/bin/setup_python.sh)

echo "Setup Perl"
bash <(curl -fsSL https://raw.githubusercontent.com/machupicchubeta/dotfiles/master/bin/setup_perl.sh)

echo "Setup Java"
bash <(curl -fsSL https://raw.githubusercontent.com/machupicchubeta/dotfiles/master/bin/setup_java.sh)

echo "Setup Node.js"
bash <(curl -fsSL https://raw.githubusercontent.com/machupicchubeta/dotfiles/master/bin/setup_nodejs.sh)

echo "Apply private settings"
if [ -f "$HOME/.laptop.local" ]; then
  . "$HOME/.laptop.local"
fi

echo "Use zsh installed via Homebrew as default shell"
if [ $SHELL != $(which zsh) ]; then
  echo "$(which zsh)" | sudo tee -a /etc/shells
  chsh -s $(which zsh)
fi
if which direnv > /dev/null; then direnv allow; fi
